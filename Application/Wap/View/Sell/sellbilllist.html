<include file="public/head" />
<div class="cont">
    <div class="tit"><a href="javascript:;" onClick="javascript:history.back(-1);"><返回</a>在售粮源</div>
    <hr>
    <div class="sel">
        <select disabled><option>玉米</option></select>
        <select disabled><option>一等</option></select>
        <select name="year" class="gy_id">
            <option>全部</option>
            <volist name="year" id="vo">
                <if condition="$_GET['gy_id'] eq $vo['gy_id']">
                    <option selected>{$vo.gy_id}</option>
                    <else/>
                    <option>{$vo.gy_id}</option>
                </if>
            </volist>
        </select>
        <select name="place" class="gp_id">
            <option>全部</option>
            <volist name="place" id="vo">
                <if condition="$_GET['gp_id'] eq $vo['gp_id']">
                    <option value="{$vo.gp_id}" selected>{$vo.gp_name}</option>
                    <else/>
                    <option value="{$vo.gp_id}">{$vo.gp_name}</option>
                </if>
            </volist>
        </select>
    </div>
    <div class="ord">

        <if condition="$_GET['t_name'] eq 'b_rz' AND $_GET['t_order'] eq 'desc' ">
            <a href="#" t_order="desc" t_name="b_rz" class="clkitem">容重<img src="/Public/app/img/ob_d.png"></a>
            <else/>
            <a href="#" t_order="asc" t_name="b_rz" class="clkitem">容重<img src="/Public/app/img/ob_a.png"></a>
        </if>


        <if condition="$_GET['t_name'] eq 'b_weig' AND $_GET['t_order'] eq 'desc' ">
            <a href="#" t_order="desc" t_name="b_weig" class="clkitem">净重<img src="/Public/app/img/ob_d.png"></a>
            <else/>
            <a href="#" t_order="asc" t_name="b_weig" class="clkitem">净重<img src="/Public/app/img/ob_a.png"></a>
        </if>

        <if condition="$_GET['t_name'] eq 'b_pri1' AND $_GET['t_order'] eq 'desc' ">
            <a href="#" t_order="desc" t_name="b_pri1" class="clkitem">单价<img src="/Public/app/img/ob_d.png"></a>
            <else/>
            <a href="#" t_order="asc" t_name="b_pri1" class="clkitem">单价<img src="/Public/app/img/ob_a.png"></a>
        </if>

        <if condition="$_GET['t_name'] eq 'b_stime' AND $_GET['t_order'] eq 'desc' ">
            <a href="#" t_order="desc" t_name="b_stime" class="clkitem">上架时间<img src="/Public/app/img/ob_d.png"></a>
            <else/>
            <a href="#" t_order="asc" t_name="b_stime" class="clkitem">上架时间<img src="/Public/app/img/ob_a.png"></a>
        </if>

    </div>
</div>
<div class="cont">
    <volist name="info.list" id="vo">
    <div class="list" onclick="location.href='/Wap/Sell/onLineBillInfo/b_id/{$vo.b_id}'">
        <div class="info1">{$vo.b_year}年 {$vo.b_place} {$vo.b_weig}吨<h3>{$vo.b_pri1|formatMoney}元/吨</h3></div>
        <div class="info2"><label>容重{$vo.b_rz}g/l</label><label>霉变{$vo.b_mb}%</label><label>水份{$vo.b_sf}%</label></div>
        <div class="info2"><label>杂质{$vo.b_zz}%</label><label>呕吐毒素{$vo.b_ot}μg/kg</label></div>
    </div>
    </volist>
    <div id="bill_list_item"></div>
</div>
<include file="public/foot" />

<input type="hidden" id="item_page" value="2" />
<input type="hidden" class="item_total_page" value="{$info.total_page}" />

<script type="text/javascript" src="/Public/bootstrap/js/jquery.min.js"></script>
<script type="text/javascript">
function getUrlParam(name) {
    var reg = new RegExp("(^|&)" + name + "=([^&]*)(&|$)"); //构造一个含有目标参数的正则表达式对象
    var r = window.location.search.substr(1).match(reg);  //匹配目标参数
    if (r != null) return unescape(r[2]); return null; //返回参数值
}
function isEmpty(v) {
    switch (typeof v) {
        case 'undefined':
            return true;
        case 'string':
            if (v.replace(/(^[ \t\n\r]*)|([ \t\n\r]*$)/g, '').length == 0) return true;
            break;
        case 'boolean':
            if (!v) return true;
            break;
        case 'number':
            if (0 === v || isNaN(v)) return true;
            break;
        case 'object':
            if (null === v || v.length === 0) return true;
            for (var i in v) {
                return false;
            }
            return true;
    }
    return false;
}

var url = '/Wap/Sell/sellBillList?';
// 排序
$(".clkitem").on('click tap',function(){
    // 设置url  有年份和产地时 把年份和产地参数带上
    var url_gy_id = getUrlParam('gy_id');
    var url_gp_id = getUrlParam('gp_id');
    if (!isEmpty(url_gy_id)) {
        url = url + '&gy_id=' + url_gy_id;
    }

    if (!isEmpty(url_gp_id)) {
        url = url + '&gp_id=' + url_gp_id;
    }

    // 重新设置排序属性
    var t_name = $(this).attr('t_name');
    var t_order = $(this).attr('t_order');
    if (t_order == 'desc') {
        s_order = 'asc';
    }
    else {
        s_order = 'desc';
    }
    // 拼链接
    window.location.href = url + "&t_name=" + t_name + "&t_order=" + s_order ;
});

// 年份
$(".gy_id").on('change', function(){
    // 地点链接
    var url_gp_id = getUrlParam('gp_id');
    if (!isEmpty(url_gp_id)) {
        url = url + '&gp_id=' + url_gp_id;
    }

    //排序链接
    var url_t_name = getUrlParam('t_name');
    if (!isEmpty(url_t_name)) {
        url = url + '&t_name=' + url_t_name;
    }

    var url_t_order = getUrlParam('t_order');
    if (!isEmpty(url_t_order)) {
        url = url + '&t_order=' + url_t_order;
    }

    var gy_id = $(this).val();
    if (!isEmpty(gy_id)) {
        window.location.href = url + "&gy_id=" + gy_id;
    }
    else {
        window.location.href = url;
    }
});

// 产地
$(".gp_id").on('change', function(){
    // 年份链接
    var url_gy_id = getUrlParam('gy_id');
    if (url_gy_id != null) {
        url = url + '&gy_id=' + url_gy_id;
    }

    //排序链接
    var url_t_name = getUrlParam('t_name');
    if (url_t_name != null) {
        url = url + '&t_name=' + url_t_name;
    }

    var url_t_order = getUrlParam('t_order');
    if (url_t_order != null) {
        url = url + '&t_order=' + url_t_order;
    }

    var gp_id = $(this).val();
    if (!isEmpty(gp_id)) {
        window.location.href = url + "&gp_id=" + gp_id;
    }
    else {
        window.location.href = url;
    }
});


// 声明参数 并添加筛选条件参数
var ajaxUrl = '/Wap/Sell/ajaxGetPageSellBillList?';
var url_gy_id = getUrlParam('gy_id');
var url_gp_id = getUrlParam('gp_id');
if (!isEmpty(url_gy_id)) {
    ajaxUrl = ajaxUrl + '&gy_id=' + url_gy_id;
}

if (!isEmpty(url_gp_id)) {
    ajaxUrl = ajaxUrl + '&gp_id=' + url_gp_id;
}

//排序链接
var url_t_name = getUrlParam('t_name');
if (!isEmpty(url_t_name)) {
    ajaxUrl = ajaxUrl + '&t_name=' + url_t_name;
}
var url_t_order = getUrlParam('t_order');
if (!isEmpty(url_t_order)) {
    ajaxUrl = ajaxUrl + '&t_order=' + url_t_order;
}

$(window).scroll(function(){
    //判断是否滑动到页面底部
    if($(window).scrollTop() === $(document).height() - $(window).height()){
        //当前第几页
        var page = $("#item_page").val();
        $("#item_page").val(parseInt(page) + 1);

        // 共几页
        var total_page = parseInt($(".item_total_page").val());
        if (page > total_page) {
            return false;
        }

        $.ajax({
            type: 'POST',
            url: ajaxUrl + '&p=' + page,
            dataType: 'json',
            timeout: 10000,
            success: function(data){
                if (data.list == null) {
                    return false;
                }
                else {
                    $("#bill_list_item").append(data.list);
                }
            },
            error: function(xhr, type){
                alert('抱歉,加载失败!');
            }
        });

    }
});
</script>